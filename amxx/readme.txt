SubnetBan. AMXX плагин для блокировки подсетей на сервере

Автор: Lev
Версия: 1.8
Источник: http://aghl.ru/forum/viewtopic.php?f=19&t=282

Информация:
* автоматическое определение подсети для заданного ИП с помощью баз GeoIP и Whois
* хранение банов подсетей в ini файле или в mysql базе (задается при компиляци)
* сохраняет резервную копию ini файла при разбане подсети
* хранит следующую информацию о бане подсети:
* начальный адрес подсети
* конечный адрес подсети
* разрешенные клиенты (флаги)
* дата бана
* последняя дата блокировки подключения из этой подсети
* причина бана
* АМХХ логгирование использования команд
* по умолчанию используется флаг доступа 'n' к командам плагина (можете поменять в файле cmdaccess.ini)
* показывает всем игрокам уведомление о вновь подключившемся игроке (выводится страна)
* интеграция с dproto, при подключении игрока, если его ИП попадает в забаненную подсеть, то:
* проверяется тип клиента используемого игроком и, если этот тип разрешен для данной подсети, то пускает клиента,
* иначе игроку сообщается о типе разрешенных клиентов и линк на скачку клиента.
* можете использовать этот плагин и без dproto, если желаете
* автоматическое создание базы данных и(или) таблицы (требуются достаточные права mysql юзера).

Команды:
sb_help показывает помощь по использованию других команд
sb_ban добавляет бан подсети по: игроку (используется его ИП для автоматического определения подсети), ИП (используется для автоматического определения подсети), начальному и конечному ИП, или подсети в CIDR формате
sb_unban удаляет бан подсети по: ИП (удалит одну, самую меньшую, или все подсети содержащие этот ИП) или начальному и конечному ИП (удалит точно совпадающую или все пересекающие подсети)
sb_list вывод списка подсетей по: ИП (выведет одну, самую меньшую, или все подсети содержащие этот ИП) или начальному и конечному ИП (выведет точно совпадающую или все пересекающие подсети)
sb_search вывод подсетей содержащих в причине заданную подстроку
sb_whois запрос к базам Whois по заданному ИП или ИП игрока с выводом ответов в консоль (к сожалению использование не многопоточных сокетов приводит к лагу в игре)
sb_stat выводит список игроков на сервере с информацией: номер игрока, ник, ИП, используемая версия протокола, протокол авторизации (тип используемого клиента), страна, город, название подсети, дополнительная информация из баз Whois (последние два поля требуют sb_use_whois_on_connect "1", что приведет к лагу при подключении игрока)

Квары:
sb_sql_host "127.0.0.1" // Сервер MySql
sb_sql_user "root" // Логин к базе
sb_sql_pass "" // Пароль к базе
sb_sql_db "subnetbans" // Название базы
sb_sql_create_db "0" // Автоматическое создание базы данных и таблицы (значение 2) или только таблицы (значение 1), если они не существуют.

sb_def_allowed_clients "bdghj" // Разрешенные типы клиентов используемые по умолчанию командой sb_ban ("bdgh" = Native Steam, RevEmu, SC2009, AVSMP и RevEmu 2013)
sb_allowed_flags "ab" // Если игрок имеет следующие флаги доступа, то проверка на бан подсети для него не производится
sb_downloadurl "http://aghl.ru/files/patches/updater.exe" // Ссылка на скачивание клиента с эмулятором
sb_download_clienttype "d" // Тип клиента указанного в ссылке на скачивание
sb_announce_connected "1" // Разрешить(1)/Запретить(0) оповещение о вновь подключающихся игроках
sb_use_whois_on_connect "0" // Разрешить(1)/Запретить(0) использование баз Whois для получения информации о подключающихся игроках (приводит к лагу в игре во время запроса к базам Whois)
sb_use_whois_for_ban "1" // Разрешить(1)/Запретить(0) использование баз Whois для автоматического определения подсети при использовании команды sb_ban (приводит к лагу в игре во время запроса к базам Whois)

Требования:
модуль GeoIpMax: geoipmax_amxx.dll (Windows) / geoipmax_amxx_i386.so (Linux) должен быть установлен (или запретите использование модуля с помощью опции компиляции);
если вы желаете использовать запросы к базам Whois, для игрового сервера должны быть разрешены исходящие подключения TCP на порт 43 и работающий DNS клиент;
если вы желаете использовать GeoIp, то вам надо скачать базу GeoLiteCity и скопировать её в папку "addons\amxmodx\data\";
возраст пользователя 18+ или наличие технического образования.

Компиляция:
скопируйте файл "subnetban.sma" в папку "addons\amxmodx\scripting\";
скопируйте файлы "common_functions.inl", "ip_functions.inl" и "whois.inl" в папку "addons\amxmodx\scripting\inline\";
для получения SQL версии раскомментируйте (удалите символы //) строчку содержащюю "#define USING_SQL" в файле "subnetban.sma";
для получения INI версии закомментируйте (поставьте символы //) строчку содержащюю "#define USING_SQL" в файле "subnetban.sma";
для запрета использования GeoIpMax модуля закомментируйте (поставьте символы //) строчку содержащюю "#define USING_GEOIP" в файле "subnetban.sma";
для разрешения использования GeoIpMax модуля раскомментируйте (удалите символы //) строчку содержащюю "#define USING_GEOIP" в файле "subnetban.sma";
введите "compile.exe subnetban.sma" (Windows) или "compile.sh subnetban.sma" (Linux) в командной строке (или смотрите тему Компиляция плагинов AMX Mod X);
скомпилированный плагин (subnetban.amxx) будет находиться в папке "addons\amxmodx\scripting\compiled\";
рекомендуется переименовать файл с SQL версией в subnetban_sql.amxx.

Инсталляция:
1. скопируйте файл "subnetban.txt" в папку "addons\amxmodx\data\lang\";
2. скопируйте файл "subnetban_sql.amxx" в папку "addons\amxmodx\plugins\";
3. добавьте строчку "subnetban_sql.amxx" в файл "addons\amxmodx\config\plugins.ini";
4. создайте базу MySql используя приведенный ниже скрипт;
5. установите значения кваров для доступа к базе данных в конфиг файле (например в server.cfg);
6. скопируйте "geoipmax_amxx.dll" (Windows) или "geoipmax_amxx_i386.so" (Linux) в папку "addons\amxmodx\modules\";
7. скачайте GeoLiteCity базу по ссылке http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz и распакуйте её в папку "addons\amxmodx\data\";
8. также можете обновить базу GeoLiteCountry, скачайте её по ссылке http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz и распакуйте её в папку "addons\amxmodx\data\";
9. звук buttons\bell1.wav используется для оповещения о подключившемся игроке, так что проверьте что он есть в папке "valve\sounds\buttons\" на сервере.

SQL запрос для создания базы данных:

CREATE DATABASE IF NOT EXISTS `subnetbans` DEFAULT CHARACTER SET latin1 COLLATE latin1_general_ci;
	CREATE TABLE IF NOT EXISTS `subnetbans`.`subnetbans` (
	`startip` INT UNSIGNED NOT NULL,
	`endip` INT UNSIGNED NOT NULL,
	`allowedclients` SMALLINT UNSIGNED NOT NULL,
	`datetimebanned` INT UNSIGNED NOT NULL,
	`datetimelastblocked` INT UNSIGNED NOT NULL,
	`reason` VARCHAR( 64 ) NOT NULL ,
	UNIQUE `startip_endip` ( `startip`, `endip` ),
	INDEX `startip` ( `startip` ),
	INDEX `endip` ( `endip` )
);
